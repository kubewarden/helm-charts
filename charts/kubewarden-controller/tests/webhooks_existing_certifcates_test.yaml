suite: existing certificates are not overwritten
templates:
  - webhooks.yaml
release:
  namespace: "kubewarden"
kubernetesProvider:
  # Simulate the presence of the kubewarden-ca and kubewarden-webhook-server-cert secrets
  scheme:
    "v1/Secret":
      gvr:
        version: "v1"
        resource: "secrets"
      namespaced: true
  objects:
    - kind: Secret
      apiVersion: v1
      metadata:
        name: kubewarden-ca
        namespace: kubewarden
      data:
        ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJwekNDQVV5Z0F3SUJBZ0lSQU44bS90YmErRVp6SVZOaFNNY1dHNjB3Q2dZSUtvWkl6ajBFQXdJd0l6RWgKTUI4R0ExVUVBeE1ZYTNWaVpYZGhjbVJsYmkxamIyNTBjbTlzYkdWeUxXTmhNQjRYRFRJMU1ETXdNekUzTXpReApOMW9YRFRNMU1ETXdNVEUzTXpReE4xb3dJekVoTUI4R0ExVUVBeE1ZYTNWaVpYZGhjbVJsYmkxamIyNTBjbTlzCmJHVnlMV05oTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFeU13MGp0K0ZSTTdRWUZsY21sSTgKc20vamVXdG9wbTc3TWFsdVlNbWhrUnFaWEpoQTBZeE11elk1L0FPdlgvK2JQY0tzTmlQSEhxRm5RRkdSTnp1MApacU5oTUY4d0RnWURWUjBQQVFIL0JBUURBZ0trTUIwR0ExVWRKUVFXTUJRR0NDc0dBUVVGQndNQkJnZ3JCZ0VGCkJRY0RBakFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQjBHQTFVZERnUVdCQlM2VG9ScmtVblYrUmNjUS9BQmJFMXEKMzRVRmV6QUtCZ2dxaGtqT1BRUURBZ05KQURCR0FpRUFqZ2ZVck9QVlJOWHI0REZERXNQVTBXVEZFNU9qK2RLTAo0MXZFWnNraXlOb0NJUUQzaWptVkg4VjVnYjQ1eUIrckNHeVVwc05Tb0kwazhaNUxhNENIT1FGOURRPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
        ca.key: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSURRbHk0amY1L3lEUUpiUzl6cjdCREZLN3I2cVB4Wkx6T3ZjVXdHTmROUHZvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFeU13MGp0K0ZSTTdRWUZsY21sSThzbS9qZVd0b3BtNzdNYWx1WU1taGtScVpYSmhBMFl4TQp1elk1L0FPdlgvK2JQY0tzTmlQSEhxRm5RRkdSTnp1MFpnPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
        old-ca.crt: "b2xkLWNhLmNydA==" # the string "old-ca.crt" in base64
    - kind: Secret
      apiVersion: v1
      metadata:
        name: kubewarden-webhook-server-cert
        namespace: kubewarden
      data:
        tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNCVENDQWFxZ0F3SUJBZ0lSQUx6ZjUyOGxLdDdoTDlkZlE3U0pWd293Q2dZSUtvWkl6ajBFQXdJd0l6RWgKTUI4R0ExVUVBeE1ZYTNWaVpYZGhjbVJsYmkxamIyNTBjbTlzYkdWeUxXTmhNQjRYRFRJMU1ETXdNekUzTXpReApOMW9YRFRJMk1ETXdNekUzTXpReE4xb3dQekU5TURzR0ExVUVBeE0wYTNWaVpYZGhjbVJsYmkxamIyNTBjbTlzCmJHVnlMWGRsWW1odmIyc3RjMlZ5ZG1salpTNXJkV0psZDJGeVpHVnVMbk4yWXpCWk1CTUdCeXFHU000OUFnRUcKQ0NxR1NNNDlBd0VIQTBJQUJOZE9MZkhFb1FKSEpwcEVjTms2cDE4a1VQRkJYMUZRMVFHUmZuKzhsOGFHTEpFYwphalp0blVzRzVjanJEdUNuMlZDMzFoVkpTY3lHVEJHNXBJeE45SjJqZ2FJd2daOHdEZ1lEVlIwUEFRSC9CQVFECkFnV2dNQjBHQTFVZEpRUVdNQlFHQ0NzR0FRVUZCd01CQmdnckJnRUZCUWNEQWpBTUJnTlZIUk1CQWY4RUFqQUEKTUI4R0ExVWRJd1FZTUJhQUZMcE9oR3VSU2RYNUZ4eEQ4QUZzVFdyZmhRVjdNRDhHQTFVZEVRUTRNRGFDTkd0MQpZbVYzWVhKa1pXNHRZMjl1ZEhKdmJHeGxjaTEzWldKb2IyOXJMWE5sY25acFkyVXVhM1ZpWlhkaGNtUmxiaTV6CmRtTXdDZ1lJS29aSXpqMEVBd0lEU1FBd1JnSWhBTzh1VkFBSE9JSnFSR3VUUlRTbVk4bW9OT1d3R0gxYjYydmsKRzRZcDAzVXNBaUVBMnNxenF6S3hNejhjYzF4U2doaDNJMDJ2d1BUY1NzMHRwYWltQUZqN21TUT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
        tls.key: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSUxJSVVpa2o5NDhZdTZHQldNUHF1NjhLNFd0YWhFY2U3Yk5tQjYwOXJObkpvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFMTA0dDhjU2hBa2NtbWtSdzJUcW5YeVJROFVGZlVWRFZBWkYrZjd5WHhvWXNrUnhxTm0yZApTd2JseU9zTzRLZlpVTGZXRlVsSnpJWk1FYm1rakUzMG5RPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
    - kind: Secret
      apiVersion: v1
      metadata:
        name: kubewarden-audit-scanner-client-cert
        namespace: kubewarden
      data:
        tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJvRENDQVVhZ0F3SUJBZ0lRR3JZNXhSUjhTSmhsQkhlYWxZVDVoREFLQmdncWhrak9QUVFEQWpBak1TRXcKSHdZRFZRUURFeGhyZFdKbGQyRnlaR1Z1TFdOdmJuUnliMnhzWlhJdFkyRXdIaGNOTWpVd016QXpNVGN6T0RNMgpXaGNOTWpZd016QXpNVGN6T0RNMldqQWZNUjB3R3dZRFZRUURFeFJoZFdScGRDMXpZMkZ1Ym1WeUxXTnNhV1Z1CmREQlpNQk1HQnlxR1NNNDlBZ0VHQ0NxR1NNNDlBd0VIQTBJQUJGWUcxc0R0MVZHdVFSNFlYZjdWYU5jT09FWkQKNk9TUHhNSlhkWVhlVXZaQ0MzeW9KWmMwWWUzdW0rZ3NNNUE3SkNOT1NEa1JrVGplWndUOGtRR3FlcTZqWURCZQpNQTRHQTFVZER3RUIvd1FFQXdJRm9EQWRCZ05WSFNVRUZqQVVCZ2dyQmdFRkJRY0RBUVlJS3dZQkJRVUhBd0l3CkRBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JTNlRvUnJrVW5WK1JjY1EvQUJiRTFxMzRVRmV6QUsKQmdncWhrak9QUVFEQWdOSUFEQkZBaUVBcHJWT2VoaVhlRXdxbTVIL2tscFAxY3JzSzRmV1dXNmp4cnExY2lzRwo4dTRDSUJYVHNjSXFrd1l2NjdYYy9vSzhXR0hJSWgybjV4WUdZUU5acFU3cEpFZVgKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
        tls.key: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSU1sTGw5RHRzMlU4YWtEVXlOV1dla3F1eVRlWlRVM081QmRFRVh4VlNOaXRvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFVmdiV3dPM1ZVYTVCSGhoZC90Vm8xdzQ0UmtQbzVJL0V3bGQxaGQ1UzlrSUxmS2dsbHpSaAo3ZTZiNkN3emtEc2tJMDVJT1JHUk9ONW5CUHlSQWFwNnJnPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
tests:
  - it: "should reuse the existing CA certificate"
    documentSelector:
      path: metadata.name
      value: kubewarden-ca
    asserts:
      - equal:
          path: data["ca.crt"]
          value: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJwekNDQVV5Z0F3SUJBZ0lSQU44bS90YmErRVp6SVZOaFNNY1dHNjB3Q2dZSUtvWkl6ajBFQXdJd0l6RWgKTUI4R0ExVUVBeE1ZYTNWaVpYZGhjbVJsYmkxamIyNTBjbTlzYkdWeUxXTmhNQjRYRFRJMU1ETXdNekUzTXpReApOMW9YRFRNMU1ETXdNVEUzTXpReE4xb3dJekVoTUI4R0ExVUVBeE1ZYTNWaVpYZGhjbVJsYmkxamIyNTBjbTlzCmJHVnlMV05oTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFeU13MGp0K0ZSTTdRWUZsY21sSTgKc20vamVXdG9wbTc3TWFsdVlNbWhrUnFaWEpoQTBZeE11elk1L0FPdlgvK2JQY0tzTmlQSEhxRm5RRkdSTnp1MApacU5oTUY4d0RnWURWUjBQQVFIL0JBUURBZ0trTUIwR0ExVWRKUVFXTUJRR0NDc0dBUVVGQndNQkJnZ3JCZ0VGCkJRY0RBakFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQjBHQTFVZERnUVdCQlM2VG9ScmtVblYrUmNjUS9BQmJFMXEKMzRVRmV6QUtCZ2dxaGtqT1BRUURBZ05KQURCR0FpRUFqZ2ZVck9QVlJOWHI0REZERXNQVTBXVEZFNU9qK2RLTAo0MXZFWnNraXlOb0NJUUQzaWptVkg4VjVnYjQ1eUIrckNHeVVwc05Tb0kwazhaNUxhNENIT1FGOURRPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
      - equal:
          path: data["ca.key"]
          value: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSURRbHk0amY1L3lEUUpiUzl6cjdCREZLN3I2cVB4Wkx6T3ZjVXdHTmROUHZvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFeU13MGp0K0ZSTTdRWUZsY21sSThzbS9qZVd0b3BtNzdNYWx1WU1taGtScVpYSmhBMFl4TQp1elk1L0FPdlgvK2JQY0tzTmlQSEhxRm5RRkdSTnp1MFpnPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
      - equal:
          path: data["old-ca.crt"]
          value: "old-ca.crt" # the string "old-ca.crt" in base64
          decodeBase64: true
  - it: "should reuse the existing leaf certificate (webhook server)"
    documentSelector:
      path: metadata.name
      value: kubewarden-webhook-server-cert
    asserts:
      - equal:
          path: data["tls.crt"]
          value: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNCVENDQWFxZ0F3SUJBZ0lSQUx6ZjUyOGxLdDdoTDlkZlE3U0pWd293Q2dZSUtvWkl6ajBFQXdJd0l6RWgKTUI4R0ExVUVBeE1ZYTNWaVpYZGhjbVJsYmkxamIyNTBjbTlzYkdWeUxXTmhNQjRYRFRJMU1ETXdNekUzTXpReApOMW9YRFRJMk1ETXdNekUzTXpReE4xb3dQekU5TURzR0ExVUVBeE0wYTNWaVpYZGhjbVJsYmkxamIyNTBjbTlzCmJHVnlMWGRsWW1odmIyc3RjMlZ5ZG1salpTNXJkV0psZDJGeVpHVnVMbk4yWXpCWk1CTUdCeXFHU000OUFnRUcKQ0NxR1NNNDlBd0VIQTBJQUJOZE9MZkhFb1FKSEpwcEVjTms2cDE4a1VQRkJYMUZRMVFHUmZuKzhsOGFHTEpFYwphalp0blVzRzVjanJEdUNuMlZDMzFoVkpTY3lHVEJHNXBJeE45SjJqZ2FJd2daOHdEZ1lEVlIwUEFRSC9CQVFECkFnV2dNQjBHQTFVZEpRUVdNQlFHQ0NzR0FRVUZCd01CQmdnckJnRUZCUWNEQWpBTUJnTlZIUk1CQWY4RUFqQUEKTUI4R0ExVWRJd1FZTUJhQUZMcE9oR3VSU2RYNUZ4eEQ4QUZzVFdyZmhRVjdNRDhHQTFVZEVRUTRNRGFDTkd0MQpZbVYzWVhKa1pXNHRZMjl1ZEhKdmJHeGxjaTEzWldKb2IyOXJMWE5sY25acFkyVXVhM1ZpWlhkaGNtUmxiaTV6CmRtTXdDZ1lJS29aSXpqMEVBd0lEU1FBd1JnSWhBTzh1VkFBSE9JSnFSR3VUUlRTbVk4bW9OT1d3R0gxYjYydmsKRzRZcDAzVXNBaUVBMnNxenF6S3hNejhjYzF4U2doaDNJMDJ2d1BUY1NzMHRwYWltQUZqN21TUT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
      - equal:
          path: data["tls.key"]
          value: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSUxJSVVpa2o5NDhZdTZHQldNUHF1NjhLNFd0YWhFY2U3Yk5tQjYwOXJObkpvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFMTA0dDhjU2hBa2NtbWtSdzJUcW5YeVJROFVGZlVWRFZBWkYrZjd5WHhvWXNrUnhxTm0yZApTd2JseU9zTzRLZlpVTGZXRlVsSnpJWk1FYm1rakUzMG5RPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
  - it: "should reuse the existing leaf certificate (audit-scanner)"
    documentSelector:
      path: metadata.name
      value: kubewarden-audit-scanner-client-cert
    asserts:
      - equal:
          path: data["tls.crt"]
          value: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJvRENDQVVhZ0F3SUJBZ0lRR3JZNXhSUjhTSmhsQkhlYWxZVDVoREFLQmdncWhrak9QUVFEQWpBak1TRXcKSHdZRFZRUURFeGhyZFdKbGQyRnlaR1Z1TFdOdmJuUnliMnhzWlhJdFkyRXdIaGNOTWpVd016QXpNVGN6T0RNMgpXaGNOTWpZd016QXpNVGN6T0RNMldqQWZNUjB3R3dZRFZRUURFeFJoZFdScGRDMXpZMkZ1Ym1WeUxXTnNhV1Z1CmREQlpNQk1HQnlxR1NNNDlBZ0VHQ0NxR1NNNDlBd0VIQTBJQUJGWUcxc0R0MVZHdVFSNFlYZjdWYU5jT09FWkQKNk9TUHhNSlhkWVhlVXZaQ0MzeW9KWmMwWWUzdW0rZ3NNNUE3SkNOT1NEa1JrVGplWndUOGtRR3FlcTZqWURCZQpNQTRHQTFVZER3RUIvd1FFQXdJRm9EQWRCZ05WSFNVRUZqQVVCZ2dyQmdFRkJRY0RBUVlJS3dZQkJRVUhBd0l3CkRBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JTNlRvUnJrVW5WK1JjY1EvQUJiRTFxMzRVRmV6QUsKQmdncWhrak9QUVFEQWdOSUFEQkZBaUVBcHJWT2VoaVhlRXdxbTVIL2tscFAxY3JzSzRmV1dXNmp4cnExY2lzRwo4dTRDSUJYVHNjSXFrd1l2NjdYYy9vSzhXR0hJSWgybjV4WUdZUU5acFU3cEpFZVgKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
      - equal:
          path: data["tls.key"]
          value: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSU1sTGw5RHRzMlU4YWtEVXlOV1dla3F1eVRlWlRVM081QmRFRVh4VlNOaXRvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFVmdiV3dPM1ZVYTVCSGhoZC90Vm8xdzQ0UmtQbzVJL0V3bGQxaGQ1UzlrSUxmS2dsbHpSaAo3ZTZiNkN3emtEc2tJMDVJT1JHUk9ONW5CUHlSQWFwNnJnPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=
  - it: "should inject the caBundle (ca + old ca) into the webhook configurations"
    documentSelector:
      path: apiVersion
      value: admissionregistration.k8s.io/v1
      matchMany: true
    asserts:
      - equal:
          path: webhooks[*].clientConfig.caBundle
          value: |-
            -----BEGIN CERTIFICATE-----
            MIIBpzCCAUygAwIBAgIRAN8m/tba+EZzIVNhSMcWG60wCgYIKoZIzj0EAwIwIzEh
            MB8GA1UEAxMYa3ViZXdhcmRlbi1jb250cm9sbGVyLWNhMB4XDTI1MDMwMzE3MzQx
            N1oXDTM1MDMwMTE3MzQxN1owIzEhMB8GA1UEAxMYa3ViZXdhcmRlbi1jb250cm9s
            bGVyLWNhMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEyMw0jt+FRM7QYFlcmlI8
            sm/jeWtopm77MaluYMmhkRqZXJhA0YxMuzY5/AOvX/+bPcKsNiPHHqFnQFGRNzu0
            ZqNhMF8wDgYDVR0PAQH/BAQDAgKkMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEF
            BQcDAjAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBS6ToRrkUnV+RccQ/ABbE1q
            34UFezAKBggqhkjOPQQDAgNJADBGAiEAjgfUrOPVRNXr4DFDEsPU0WTFE5Oj+dKL
            41vEZskiyNoCIQD3ijmVH8V5gb45yB+rCGyUpsNSoI0k8Z5La4CHOQF9DQ==
            -----END CERTIFICATE-----
            old-ca.crt
          decodeBase64: true
