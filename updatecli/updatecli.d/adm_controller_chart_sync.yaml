# This Updatecli policy is only compatible for UNIX system
# And designed to be call such as
# ```
# updatecli apply --config updatecli/updatecli.d/sbomscanner_chart_sync.yaml --values updatecli/values.yaml
# ```

name: sync Adm Controller helm charts
pipelineid: adm_controller_release

targets:
  default:
    name: "chore: sync Adm Controller helm charts"
    kind: shell
    scmid: default
    disablesourceinput: true
    spec:
      changedif:
        kind: exitcode
        spec:
          success: 0
          failure: 1
          warning: 2
      command: |
        set -e

        # Custom exit code used by Updatecli to understand
        # how to handle the script output
        # Exit 1 if something went wrong
        # Exit 2 if the script changed chart files
        # Exit 0 if nothing changed at the end of the script

        GIT_REPO="https://github.com/kubewarden/kubewarden-controller.git"

        # The GIT_DIR is an arbritary directory that use
        # to temporary git clone the kubewarden-controller git repository
        GIT_DIR="/tmp/updatecli/tmp/kubewarden-controller"

        CHARTS_DIR="charts"
        GIT_DIR_SUB_PATH="$CHARTS_DIR"

        ## Remove any existing directory
        ## to start from a fresh environment
        if [ -d "$GIT_DIR" ]; then
          rm -Rf "$GIT_DIR"
        fi

        ## Only clone the Helm chart directory that we need to sync
        git clone --depth 1 --filter=blob:none "$GIT_REPO" --sparse "$GIT_DIR"
        CURRENT_DIR=$PWD
        cd "$GIT_DIR" || exit 1
        git sparse-checkout set "$GIT_DIR_SUB_PATH"
        cd "$CURRENT_DIR" || exit 1

        # Calculate checksum of all charts before update
        BEFORE_CHECKSUM=""
        if [ -d "$CHARTS_DIR" ]; then
          BEFORE_CHECKSUM=$(find "$CHARTS_DIR" -type f -exec sha256sum {} \;)
        fi

        # Calculate checksum of all charts in cloned repo
        CURRENT_DIR=$PWD
        cd "$GIT_DIR" || exit 1
        AFTER_CHECKSUM=$(find "$GIT_DIR_SUB_PATH" -type f -exec sha256sum {} \;)
        cd "$CURRENT_DIR" || exit 1

        # To keep Updatecli idempotent, we only change the files
        # if we are not in dry run mode
        # DRY_RUN is an environment variable set by Updatecli
        # depending if we execute `updatecli apply` or `updatecli diff`
        if [ "$DRY_RUN" = "false" ]; then
           for chart in "$GIT_DIR/$GIT_DIR_SUB_PATH"/*; do
             if [ -d "$chart" ]; then
               cp -R "$chart" "$CHARTS_DIR/"
             fi
           done
           AFTER_CHECKSUM=$(find "$CHARTS_DIR" -type f -exec sha256sum {} \;)
        fi

        if [ "$BEFORE_CHECKSUM" = "$AFTER_CHECKSUM" ]; then
          exit 0
        fi

        exit 2

actions:
  createUpdatePR:
    title: "Adm Controller Helm charts update"
    kind: "github/pullrequest"
    scmid: "default"
    spec:
      automerge: false
      mergemethod: squash
      description: |
        Automatic Helm charts update.
        This PR has been created by the automation used to automatically update the Admission Controller
        Helm charts from https://github.com/kubewarden/kubewarden-controller.
      draft: false
      labels:
        - "dependencies"

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.author }}"
      email: "{{ .github.email }}"
      owner: "{{ requiredEnv .github.owner }}"
      repository: "helm-charts"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ requiredEnv .github.user }}"
      branch: "{{ .github.branch }}"
      commitmessage:
        type: "chore(deps)"
        title: "Update Adm Controller Helm charts"
        hidecredit: true
        footers: "Signed-off-by: {{ .github.author }} <{{ .github.email }}>"
        squash: true
